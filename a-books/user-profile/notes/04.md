# 第4章 标签数据开发  

标签数据开发是用户画像体系搭建中最主要的环节，  
主要包括离线标签开发、实时类标签开发、用户特征库开发、人群计算、打通数据服务层等开发内容。  

离线标签开发主要围绕第2章讲的数据指标体系开发统计类标签、规则类标签、挖掘类标签等展开；  
实时类标签主要针对给用户展现实时性较强的场景开发相关数据，如首页新人弹窗、新人红包等场景；  
用户特征库围绕用户的每次行为明细记录相关数据，如用户浏览、搜索、收藏、下单等行为明细，一般该特征库按日做时间分区；  
人群计算应用在数据服务层之前，业务方需要组合用户的标签来筛选出对应人群，通过人群计算功能组合标签划分出对应的人群；  
打通数据服务层将业务方根据业务规则圈定出来的用户人群推送到不同的业务系统中去。  

## 4.1 统计类标签开发  
4.1.1 近30日购买行为标签案例  
4.1.2 最近来访标签案例  

## 4.2 规则类标签开发  
4.2.1 用户价值类标签案例   
4.2.2 用户活跃度标签案例  

## 4.3 挖掘类标签开发  
4.3.1 案例背景  
4.3.2 特征选取及开发  
4.3.3 文本分词处理  
4.3.4 数据结构处理  
4.3.5 文本TF-IDF权重  
4.3.6 朴素贝叶斯分类  

## 4.4 流式计算标签开发  

前面3节介绍的是离线标签的开发，即批次ETL任务，一般为T+1日的数据。本节内容介绍实时标签数据的开发。    

在做实时订单分析，或者给首次登录App的新人用户弹窗推送、发放红包，  
实时分析用户所处场景并进行推送中有广泛的应用，这里使用Spark Streaming开发相关的实时数据。  

### 4.4.1 流式标签建模框架  

Spark Streaming是Spark Core API的扩展，支持实时数据流的处理，并且有可扩展、高吞吐量、容错的特点。  
数据可以从Kafka、Flume等多个来源获取，可以使用map、reduce、window等多个高级函数对业务逻辑进行处理。  
最后，处理后的数据被推送到文件系统、数据库等。  

在内部Spark Streaming接收实时数据流并将数据分成多个batch批次，然后由Spark引擎进行处理，批量生成结果流。  
Spark Streaming提供了一个高层抽象，称为Discretized Stream或Dstream，它表示连续的数据流。  
Dstream可以通过Kafka、Flume等来源的数据流创建，也可以通过在其他Dstream上应用高级操作来创建。  

![](http://pic.yupoo.com/sunnnychan/a95ec07b/7f019a1b.jpeg)

![](http://pic.yupoo.com/sunnnychan/5433c8a2/4d729ca1.jpeg)  

### 4.4.2 Kafka简介  

Kafka的核心功能是作为分布式消息中间件。  
Kafka集群由多个Broker server组成，其中，消息的发送者称为Producer；  
消息的消费者称为Cousumer；  
Broker是消息处理的节点，多个Broker组成Kafka集群；  
Topic是数据主题，用来区分不同的业务系统，消费者通过订阅不同的Topic来消费不同主题的数据，  
每个Topic又被分为多个Partition，Partition是topic的分组，每个Partition都是一个有序队列；  
offset用于定位消费者在每个Partition中消费的位置。  



### 4.4.3 Spark Streaming集成Kafka  

Spark Streaming可以通过Receiver和Direct两种模式来集成Kafka。  


### 4.4.4 标签开发及工程化  

实时类标签的处理流程主要包括4个部分：  
* 读取数据源，这里讲解消费Kafka中的数据；
* 解析数据，即解析消费的Kafka数据；
* 将解析后的数据存储到指定位置（如MySQL、HDFS、HBase等）；
* 存储消费的Offset，Direct模式下需要保存消费到的位置。

## 4.5 用户特征库开发  

为进一步从多个维度丰富用户特征，挖掘用户的相关行为，除了开发用户标签体系外，一般还会开发用户的特征库。  
一方面为个性化推荐、精准营销、商业分析等应用提供中间层数据，    
另一方面也可以削减不同算法在特征构建时的冗余加工。  

4.5.1 特征库规划  
4.5.2 数据开发  
4.5.3 其他特征库规划  

## 4.6 标签权重计算  
4.6.1 TF-IDF词空间向量  
4.6.2 时间衰减系数  
4.6.3 标签权重配置  

## 4.7 标签相似度计算  
4.7.1 案例场景  
4.7.2 数据开发  

## 4.8 组合标签计算  
4.8.1 应用场景  
4.8.2 数据计算  

## 4.9 数据服务层开发  
4.9.1 推送至营销系统  
4.9.2 接口调用服务  

## 4.10 GraphX图计算用户  

Spark GraphX是分布式图计算框架，基于Spark平台提供了对图计算的简单且丰富的接口，以满足对分布式图处理的需求。  
对GraphX视图的所有计算，最终会转化为其关联的Table视图的RDD操作来完成。  
在工程实践中，存在需要计算二度关系用户的场景，  
即用户与用户之间通过其共同的好友找到他们的二度关系熟人，这种对图的挖掘计算可借助Spark GraphX完成。  



4.10.2 数据开发案例  
4.11 本章小结 